# Конституция проекта резервного копирования PowerShell
Этот файл является проектной конституцией и хранится как .specify/memory/constitution.md.
Его положения задают неколебимые правила и ограничения, которыми обязаны руководствоваться и разработчики, и AI‑агенты Spec Kit при спецификации, планировании, разбиении на задачи и реализации.​

## 1. Назначение и область применения
1.1. Проект реализует сценарии резервного копирования файлов и папок под Windows с использованием PowerShell‑скриптов и модулей. Он обеспечивает создание локальных архивов, их последующую доставку в сетевое хранилище и управляемую ротацию старых резервных копий.

1.2. Проект не решает задачи планирования запуска (расписание задач), шифрования архивов, управления правами доступа на стороне серверов и долгосрочного хранения по регуляторным политикам. Эти задачи выполняются внешними системами (Task Scheduler, системы шифрования, политики хранения).

## 2. Базовые принципы разработки
### 2.1. PowerShell‑first и совместимость
Весь код должен быть написан на PowerShell и быть полностью совместимым с Windows PowerShell 5.1.
Использование внешних CLI‑утилит (RAR, 7z и т.п.) допускается только через изолированные адаптеры‑модули с чётким интерфейсом.

### 2.2. KISS и бритва Оккама
Решения должны быть максимально простыми и очевидными при сохранении надёжности и поддерживаемости.
Избыточные абстракции, «умные» трюки и чрезмерно глубокие пайплайны, усложняющие чтение и отладку, запрещены.

### 2.3. DRY и композиция вместо наследования
Повторяющаяся логика обязана выноситься в отдельные функции и модули; копирование кода считается архитектурной ошибкой.
Расширение поведения должно выполняться через композицию и явные зависимости, а не через усложнение иерархий и скрытые связи.

### 2.4. SOLID и единственная ответственность
Каждый модуль и каждая функция должны иметь одну чётко определённую ответственность в домене резервного копирования.
Добавление новой ответственности к существующему модулю или функции без веских оснований запрещено; в таких случаях должен создаваться новый модуль/функция.

### 2.5. YAGNI и разумный BDUF
Реализовывается только функциональность, явно зафиксированная в спецификации и планах; «код на будущее» без требований запрещён.​
Планирование должно быть достаточным для понимания архитектуры и инвариантов, но не превращаться в избыточное предварительное проектирование, тормозящее поставку.

### 2.6. APO (Avoid Premature Optimization)
Оптимизация производительности допускается только при наличии измеримой проблемы и понятных целевых метрик.
Приоритет: корректность и простота кода важнее гипотетической оптимизации.

### 2.7. Чистый и предсказуемый код
Скрытые побочные эффекты запрещены: любая модификация файловой системы, конфигурации или логов должна быть очевидна из названия и описания функции/скрипта.
Имена функций, параметров и файлов должны однозначно отражать назначение, без двусмысленных или излишне общих названий.

### 2.8. Простой шаблон comment‑based help (PS 5.1)
Каждый скрипт и каждая публичная функция обязаны содержать в начале блок comment‑based help с ключевыми элементами .SYNOPSIS, .DESCRIPTION, .PARAMETER и .EXAMPLE.​
Требуемый минимум:
.SYNOPSIS — одна строка с кратким описанием назначения.
.DESCRIPTION — 2–5 строк с основными сценариями использования и важными нюансами.
.PARAMETER Name — для каждого параметра кратко указать, что это за параметр и формат значения.
.EXAMPLE — одна или более типичных команд вызова с реальными значениями.
Использование дополнительных модулей для генерации справки (включая PlatyPS) не является обязательным и в общем случае не должно вводиться без явной необходимости.

### 2.9. Работа с кодировками и русскими символами
Все скрипты и модули должны корректно обрабатывать русские символы (кириллицу) в именах файлов, путях и содержимом.
Любой текстовый вывод, будь то в консоль или в лог-файлы, должен принудительно использовать кодировку UTF-8.
При чтении текстовых файлов из внешних источников или выводе от CLI-утилит необходимо явно определять их кодировку и преобразовывать в UTF-8 перед обработкой. Это гарантирует консистентность и предсказуемость поведения в русскоязычной среде Windows.

## 3. Архитектура и модульность
### 3.1. Модульная архитектура
Функциональность должна быть разделена на отдельные модули (.psm1) по доменным зонам: логирование, архивирование, копирование, ротация, уведомления и т.п.
Каждый модуль обязан иметь чётко определённый публичный контракт (экспортируемые функции) и минимальное внутреннее состояние.

### 3.2. Главные сценарии и оркестрация
Основные сценарии резервного копирования оформляются в отдельных скриптах (.ps1), выполняющих роль оркестрации и содержащих минимально возможное количество бизнес‑логики.
Весь нетривиальный функционал должен находиться в модулях; расширение сценариев не должно приводить к разрастанию логики в стартовых скриптах.

### 3.3. Расширяемость без поломки контрактов
Добавление нового типа архива, способа доставки или сценария бэкапа должно выполняться через новые модули или новые функции с сохранением действующих интерфейсов.
Ломающее изменение публичных контрактов допускается только при явной миграционной стратегии, отражённой в спецификациях и планах.

## 4. Доменные инварианты резервного копирования
### 4.1. Порядок операций
Архив обязан сначала создаваться локально на машине запуска скрипта.
До успешного завершения локального архивирования любые операции удаления или ротации старых архивов запрещены.

### 4.2. Копирование в сетевое хранилище
Копирование архива в сетевое хранилище допускается только после проверки успешного создания архива (код возврата, наличие и размер файла, при необходимости контрольная проверка).
Ошибки копирования не должны приводить к безусловному удалению единственной валидной копии резервного архива.

### 4.3. Политика ротации и безопасность удаления
Любое удаление старых архивов должно подчиняться фиксированным правилам: минимальное количество последних резервных копий и/или минимальное окно хранения в днях.
Модуль ротации обязан поддерживать режим предварительного просмотра (dry‑run) или выдавать подробный список файлов, подлежащих удалению, до фактического удаления.

### 4.4. Полнота и трассируемость
Для каждого созданного архива должен формироваться отдельный лог‑файл со списком всех добавленных файлов и их ключевых атрибутов (путь, размер, дата модификации).
Отсутствие такого лога считается ошибкой процесса и должно приводить к явному сигналу (ошибка или, как минимум, предупреждение).

## 5. Логирование, ошибки и наблюдаемость
### 5.1. Обязательное логирование
Все ключевые этапы (старт сценария, создание архива, проверка, копирование, ротация, уведомление) обязаны логироваться с уровнями как минимум Info/Warning/Error.
Запись журнала должна как минимум содержать дату/время, уровень, источник (модуль/функция), сообщение и релевантный контекст (пути, коды результатов).

### 5.2. Обработка ошибок
Для всех небанальных операций должны применяться конструкции try { } catch { } finally { } с обязательным логированием исключений и контекста.
Любая ошибка должна быть зафиксирована в логе; silent‑fail запрещён.

### 5.3. Безопасность логов
Логи не должны содержать секреты (пароли, токены, строки подключения, персональные данные).
В случаях необходимости идентификации допускаются только маскированные значения или устойчивые к утечке идентификаторы.

### 5.4. Уведомления
Подсистема уведомлений (например, email) должна сообщать агрегированный результат сценария (успех/частичный успех/ошибка) и ссылки на лог‑файлы, но не дублировать доменную логику.
Неудача отправки уведомления не должна автоматически помечать бэкап как неуспешный, но обязана логироваться как предупреждение.

## 6. Конфигурация и безопасность
### 6.1. Конфигурация в основном скрипте
Основной сценарий резервного копирования (например, Backup-Main-Folders-7zip-Local-Remote.ps1) является единым источником правды для конфигурации: путей источников и назначения, выбранного типа архива, политики хранения, параметров уведомлений и прочих ключевых настроек.
Конфигурационный блок должен находиться в верхней части основного скрипта и иметь явную структуру (хэш‑таблица, отдельный регион настроек и т.п.), чтобы облегчить ревью, подписание и аудит.
Такая организация конфигурации должна обеспечивать возможность подписать основной скрипт и работать в окружениях с жёсткой Execution Policy без необходимости подписывать множество вспомогательных файлов.

### 6.2. Минимизация внешних зависимостей
Ввод дополнительных конфигурационных файлов допускается только при явной необходимости и должен сопровождаться обоснованием в спецификации или плане.
Внешние модули и библиотеки должны использоваться только тогда, когда встроенных средств PowerShell недостаточно, и их добавление не усложняет процесс подписания и развёртывания скриптов.

### 6.3. Секреты и учётные данные
Запрещено хардкодить секреты (пароли, токены, строки подключения) в основном скрипте и модулях.
Секреты должны поступать из защищённых источников (переменные среды, хранилища секретов и т.п.); в конфигурации допустимы только ссылки/идентификаторы.

### 6.4. Минимально необходимые права
Скрипты должны выполняться под учётной записью с минимально необходимыми правами: доступ на чтение исходных данных и запись/изменение в каталогах бэкапов и логов.
Все операции, требующие повышенных прав, должны быть явно выделены и описаны в документации к сценарию.

## 7. Качество, тестирование и эволюция
### 7.1. Тестирование критической логики
Модули архивирования, копирования, ротации и разбора конфигурации должны иметь автоматические тесты (юнит‑ или сценарные), по возможности изолированные от реальной инфраструктуры.
Тесты обязаны покрывать как минимум крайние случаи: пустые директории, недоступное хранилище, конфликты имён файлов, превышение лимитов хранения.

### 7.2. Эволюция конституции
Все спецификации, планы и задачи должны соответствовать данной конституции; противоречащие решения недопустимы.​
Изменения в конституции допускаются только осознанно, с фиксированием мотивации и требуемых корректировок в существующих спецификациях и планах.

### 7.3. Ограничения для AI‑агента
AI‑агенту запрещено:
- отключать или ослаблять логирование и обработку ошибок;
- нарушать доменные инварианты резервного копирования (локальное архивирование до ротации и сетевого копирования и т.п.);
- добавлять тяжёлые внешние зависимости или новые конфигурационные файлы без явного запроса в спецификации.
При любых неоднозначных вариантах AI‑агент обязан выбирать решение, соответствующее KISS, YAGNI и APO и не нарушающее настоящую конституцию.

**Version**: 1.0.0 | **Ratified**: 2025-11-29 | **Last Amended**: 2025-11-29
