# Спецификация PowerShell модуля резервного копирования

## 1. Обзор
Этот документ описывает детальные функциональные и нефункциональные требования к PowerShell модулю для резервного копирования. Модуль предназначен для создания, управления и ротации резервных копий файлов и папок.

## 2. Ссылка на конституцию
Разработка модуля должна строго следовать принципам, изложенным в файле `speckit.constitution`.

## 3. Функциональные требования

### 3.1. Типы резервного копирования
- **Полное (Full):** Архивирование всех указанных файлов и папок.
- **Инкрементальное (Incremental):** Архивирование только тех файлов, которые были изменены с момента последнего *любого* бэкапа (атрибут "Archive").
- **Дифференциальное (Differential):** Архивирование только тех файлов, которые были изменены с момента последнего *полного* бэкапа.

### 3.2. Модули

#### 3.2.1. `Backup-Logger.psm1`
- **Описание:** Централизованное управление логами.
- **Функции:**
    - `Write-Log`: Записывает сообщение в основной лог-файл. Принимает уровень (INFO, WARN, ERROR) и текст сообщения.
    - `Write-ArchiveLog`: Записывает путь к файлу, добавленному в архив, в отдельный лог-файл для конкретной сессии бэкапа.
- **Требования:**
    - Лог-файлы должны иметь ротацию по дате (например, `Backup-2025-11-12.log`).
    - Все записи должны содержать временную метку.

#### 3.2.2. Модули архивации (`Backup-RAR.psm1`, `Backup-7z.psm1`, `Backup-Zip.psm1`)
- **Описание:** Создание и проверка архивов.
- **Функции (для каждого модуля):**
    - `New-Archive`: Создает архив указанного типа. Принимает пути к файлам/папкам, путь для сохранения архива, тип бэкапа.
    - `Test-Archive`: Проверяет целостность созданного архива.
- **Требования:**
    - Зависимости (консольные утилиты `rar.exe`, `7z.exe`) должны быть указаны в документации.
    - `Backup-Zip.psm1` должен использовать встроенную в PowerShell функцию `Compress-Archive`.

#### 3.2.3. `Remove-OldFiles.psm1`
- **Описание:** Ротация резервных копий.
- **Функции:**
    - `Remove-OldBackups`: Удаляет старые архивы.
- **Требования:**
    - Должен принимать два параметра:
        1. `$DaysToKeep`: Удалять файлы старше указанного количества дней.
        2. `$FilesToKeep`: Всегда сохранять указанное количество последних файлов, независимо от их возраста.

#### 3.2.4. `Backup-Copy.psm1`
- **Описание:** Копирование созданных бэкапов и логов.
- **Функции:**
    - `Copy-Backup`: Копирует артефакты бэкапа (архив и лог со списком файлов) в указанное сетевое расположение.
- **Требования:**
    - Должен поддерживать UNC-пути (например, `\\server\share`).
    - Должен проверять доступность сетевого ресурса перед копированием.
    - Должен копировать как сам файл архива (например, `pcname_JobName_20251111.rar`), так и связанный с ним лог-файл со списком заархивированных файлов (например, `pcname_JobName_20251111.log`).

#### 3.2.5. `Mail-Email-Send.psm1`
- **Описание:** Отправка уведомлений по электронной почте.
- **Функции:**
    - `Send-BackupNotification`: Отправляет email с отчетом о результатах бэкапа.
- **Требования:**
    - Конфигурация SMTP-сервера (адрес, порт, учетные данные) должна быть вынесена в конфигурационный файл.
    - В письме должен содержаться статус (Успех/Ошибка), время начала и окончания, размер архива и последние строки из лог-файла.

### 3.3. Основные скрипты (`Backup-Main-Folders.ps1`, `Backup-Main-Files.ps1`)
- **Описание:** Оркестрация процесса резервного копирования для папок и файлов.
- **Требования к `Backup-Main-Folders.ps1`:**
    - Должен поддерживать параметр для исключения вложенных каталогов из архива.
- **Требования к `Backup-Main-Files.ps1`:**
    - Должен поддерживать фильтрацию исходных файлов по маске (например, `*.txt`, `data-??.zip`).
    - Должен корректно обрабатывать файлы со сложными именами (например, `"имя файла.proc.msg.txt"`).
    - Для каждого исходного файла должен создаваться отдельный архив (например, для `"file.txt"` создается `"file.rar"`).
    - Для этого режима (`Backup-Main-Files.ps1`) не требуется создавать отдельный лог со списком файлов для каждого архива. Все операции должны логироваться только в основной, общий лог.
- **Общая логика работы:**
    1. Чтение конфигурации (что бэкапить, куда, с какими параметрами, включая фильтры и исключения).
    2. Вызов модуля архивации для создания локальной(-ых) копии(-ий).
    3. Вызов модуля архивации для проверки целостности.
    4. Вызов модуля копирования для перемещения артефактов (архивы и, если применимо, логи) в сетевое хранилище.
    5. Вызов модуля ротации для удаления старых бэкапов.
    6. Вызов модуля уведомлений для отправки отчета.

## 4. Нефункциональные требования
- **Совместимость:** Windows PowerShell 5.1.
- **Кодировка файлов:**
    - Все файлы скриптов (`.ps1`, `.psm1`) должны быть в кодировке **Windows-1251** для совместимости с Windows PowerShell ISE.
    - Все лог-файлы (`.log`) должны создаваться в кодировке **UTF-8**.
- **Обработка ошибок:** Надежная обработка всех исключений. Скрипт не должен прерываться аварийно. Любая ошибка должна быть залогирована.
- **Документация:** Каждый скрипт и модуль должен содержать исчерпывающий заголовок справки в формате `platyPS`, включающий секции `.SYNOPSIS`, `.DESCRIPTION`, `.EXAMPLE` и `.NOTES`. Описание должно быть максимально полным: назначение, параметры, результаты работы, примеры запуска.

## 5. Пример конфигурации заданий

Основные скрипты должны получать на вход хэш-таблицу с описанием заданий для резервного копирования. Это обеспечивает гибкость и позволяет управлять множеством различных бэкапов из одного места.

```powershell
$BackupJobs = @{
    # Задание 1: Бэкап целой папки
    Job1 = @{
        Source         = "C:\testBackups\JOB1_folder\"
        ListExceptions = ""  # Нет исключений
        FileOnly       = $false # Режим бэкапа папки
        FilterFiles    = "" # Нет фильтра файлов
        Archive        = "{PCName}_Job1_{Date}.rar"
        LocalDest      = "D:\testBackupsLocal\JOB1\"
        RemoteDest     = "D:\testBackupsRemote\"
    }

    # Задание 2: Бэкап отдельных файлов по маске, каждый файл в свой архив
    Job2 = @{
        Source         = "C:\testBackups\JOB2_File_in_Arh\"
        ListExceptions = ""
        FileOnly       = $true # Режим бэкапа файлов
        FilterFiles    = "*.msg" # Бэкапить только .msg файлы
        Archive        = "{PCName}_{FileName}_{Date}.rar" # Имя архива на основе имени файла
        LocalDest      = "D:\testBackupsLocal\JOB2\"
        RemoteDest     = "D:\testBackupsRemote\"
    }

    # Задание 3: Бэкап папки с исключением некоторых вложенных каталогов
    Job3 = @{
        Source         = "C:\testBackups\JOB3_folder_exect\"
        ListExceptions = @("C:\testBackups\JOB3_folder_exect\test1", "C:\testBackups\JOB3_folder_exect\test2")
        FileOnly       = $false
        FilterFiles    = ""
        Archive        = "{PCName}_JOB3_{Date}.rar"
        LocalDest      = "D:\testBackupsLocal\JOB3\"
        RemoteDest     = "D:\testBackupsRemote\"
    }
}
```

## 6. Общие параметры и настройки

В начале основного скрипта должны быть определены общие настройки, которые будут использоваться для всех заданий. Это упрощает конфигурацию и управление.

```powershell
#region Стандартные настройки

# Общее имя для группы заданий
$JobName = "testBackups"
$DomainName = "@main.local.loc"

# Настройки по умолчанию, которые могут быть переопределены в конкретном задании
$DefaultSettings = @{
    PCName          = $env:COMPUTERNAME
    JobName         = $JobName
    LogPath         = "C:\work\"+ $JobName + "\logs"
    TypeArh 	    = "rar" # Флаг для выбора архиватора: rar, 7z, zip
    RarPath         = "c:\work\rar.exe"
    # a: добавить, -m5: степень сжатия, -s: solid-архив, -ep: не сохранять пути, -rr1p: 1% recovery record, -r: рекурсия, -t: тест
    RarParameters   = @("a","-m5","-s","-ep","-rr1p","-r","-t")
	7zPath          = "c:\work\7z.exe"
    # a: добавить, -mx=9: макс. сжатие, -ms=on: solid-архив, -srr: recovery record, -t: тест
	7zParameters    = @("a", "-mx=9", "-ms=on", "-srr", "-t")
    # Параметры для встроенного Compress-Archive
    psZipParameters = @{
        CompressionLevel = "Optimal" # Может быть Optimal, Fastest, NoCompression
        Update           = $true      # Для обновления существующего архива
    }
    AdminIS         = "user1@local.loc"
    AdminOS         = "user2@local.loc"
}

# Отправитель email по умолчанию
$emailFrom = $DefaultSettings.PCName + $DomainName

# Инициализация переменных для сбора статистики
$results = @{}
$successCount = 0
$errorCount = 0

#endregion