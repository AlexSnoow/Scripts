# Create_Backup_Rar.ps1

## Назначение

Скрипт PowerShell для автоматической архивации файлов и папок с использованием WinRAR. Предоставляет гибкие возможности для создания резервных копий с поддержкой динамического именования архивов, ведения логов и настройки параметров архивации.

## Основные возможности

- **Автоматическое именование архивов** с поддержкой плейсхолдеров:
  - `{SRCfolder}` - имя исходной папки
  - `{computer}` - имя компьютера
  - `{date}` - текущая дата в формате ГГГГММДД
  - `{time}` - текущее время в формате ЧЧММСС
  - `{datetime}` - дата и время в формате ГГГГММДД-ЧЧММСС

- **Поддержка нескольких форматов архивов**: RAR, ZIP, 7Z
- **Подробное логирование**: отдельные файлы логов для вывода и ошибок
- **Проверка корректности**: валидация путей, имен файлов и доступности RAR
- **Гибкая настройка**: возможность указать собственные ключи архивации

## Параметры функции Backup-WithRAR

| Параметр         | Обязательный | Тип    | Описание                                       | По умолчанию                               |
| ---------------- | ------------ | ------ | ---------------------------------------------- | ------------------------------------------ |
| RarPath          | Нет          | String | Путь к исполняемому файлу RAR.exe              | "C:\Program Files\WinRAR\Rar.exe"          |
| SRC              | Да           | String | Путь к исходным файлам или папке для архивации | -                                          |
| DST              | Да           | String | Папка назначения для сохранения архива         | -                                          |
| ArchiveName      | Нет          | String | Имя архива с поддержкой плейсхолдеров          | "backup_{SRCfolder}_{computer}_{datetime}" |
| Keys             | Нет          | String | Ключи командной строки для RAR                 | "a -t -r -m5 -dh -tl -rr1p -s -ep2"        |
| ArchiveExtension | Нет          | String | Расширение архива (rar, zip, 7z)               | "rar"                                      |

## Ключи RAR по умолчанию

- `a` - добавить файлы в архив
- `-t` - проверить архив после создания
- `-r` - обрабатывать вложенные папки
- `-m5` - максимальная степень сжатия
- `-dh` - открывать общие файлы
- `-tl` - устанавливать время архива по самому новому файлу
- `-rr1p` - добавить информацию для восстановления (1%)
- `-s` - создавать твердый архив
- `-ep2` - исключать путь из имен файлов

## Примеры использования

### Прямой запуск скрипта
```powershell
.\Create_Backup_Rar.ps1 -SRC "C:\test\backup2" -DST "C:\test\rar" -ArchiveName "Backup-{SRCfolder}_{computer}_{datetime}"
```

### Запуск с подробным выводом
```powershell
.\Create_Backup_Rar.ps1 -SRC "C:\test\backup2" -DST "C:\test\rar" -ArchiveName "Backup-{SRCfolder}_{computer}_{datetime}" -Verbose
```

### Использование как функции из другого скрипта
```powershell
# Импорт функции
. .\Create_Backup_Rar.ps1

# Вызов функции
Backup-WithRAR -SRC "C:\Data" -DST "D:\Backups" -ArchiveName "Backup-{SRCfolder}_{computer}_{datetime}" -Keys "a -r -m5"
```

## Особенности реализации

1. **Проверка путей**: автоматическая проверка существования исходных файлов и папки назначения
2. **Создание папок**: автоматическое создание папки назначения при необходимости
3. **Валидация имен**: проверка имен архивов на наличие недопустимых символов и зарезервированных имен
4. **Обработка ошибок**: детальное логирование ошибок и различных кодов возврата RAR
5. **Ограничение длины путей**: автоматическое усечение длинных имен для совместимости с Windows MAX_PATH
6. **Условное создание логов**: лог ошибок создается только при наличии ошибок

## Коды ошибок RAR

Скрипт обрабатывает следующие коды возврата RAR:
- 0: Успешное выполнение
- 1: Предупреждения (нефатальные ошибки)
- 2: Фатальная ошибка
- 3: Ошибка в CRC проверке
- 4: Попытка обновить зашифрованный архив с неправильным паролем
- 5: Ошибка записи
- 6: Ошибка открытия файла

## Требования

- Установленный WinRAR (версия 5.0 или выше)
- PowerShell 5.0 или выше
- Права на чтение исходных файлов и запись в папку назначения

## Возможные улучшения

1. **Проверка свободного места на диске** перед началом архивации
2. **Отправка уведомлений** по электронной почте или в мессенджеры
3. **Шифрование архивов** с поддержкой паролей
4. **Интеграция с облачными хранилищами** для автоматической выгрузки архивов
5. **Расписание выполнения** через планировщик задач Windows
6. **Поддержка многотомных архивов** для больших данных

## Автор

Иванов, версия 3.0 (2025-08-24)